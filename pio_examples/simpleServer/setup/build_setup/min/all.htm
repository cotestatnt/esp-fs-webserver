<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <title>ESP FS Web Server</title>
    <meta content="width=device-width, initial-scale=1" name=viewport>
    <style>html{font-family:sans-serif}body{background:linear-gradient(135deg,#0f172a,#1e3a5f);min-height:100vh;padding:0 20px 20px}a{background-color:transparent;cursor:pointer;margin:0;padding:0}a:active,a:hover{outline:0}b{font-weight:700}h1{font-size:36px;margin:10px 0 5px}h1,h2{color:#1e3a5f}h2{font-size:24px}input:-webkit-autofill,input:-webkit-autofill:active,input:-webkit-autofill:focus,input:-webkit-autofill:hover{-webkit-box-shadow:inset 0 0 0 30px #fff!important}input[type=checkbox]{box-sizing:border-box;padding:0}input[type=number],input[type=password],input[type=text],select{background-color:#f0f9ff;border:2px solid #e0f2fe;border-radius:8px;color:#0f172a;font-size:16px;height:40px;padding:0 0 0 20px;transition:.3s;width:90%}input[type=file]{display:none}input::placeholder{color:#64748b}input:hover{border-color:#06b6d4;box-shadow:0 0 12px rgba(6,182,212,.2)}input:focus,select:focus{border-color:#0891b2;box-shadow:0 0 16px rgba(6,182,212,.3);outline:0}input[type=number]:hover::-webkit-inner-spin-button{-webkit-appearance:none;-moz-appearance:textfield}input[type=number]{appearance:textfield}footer{color:#cbd5e1;font-size:12px;margin:40px;text-align:center}.btn,button{background:linear-gradient(135deg,#06b6d4,#0891b2);border:0;border-radius:8px;box-shadow:0 4px 12px rgba(6,182,212,.3);color:#fff;cursor:pointer;display:inline-flex;font-weight:600;justify-content:center;min-width:40%;padding:12px 24px;transition:.3s}.btn:hover,button:hover{box-shadow:0 6px 16px rgba(6,182,212,.4);filter:brightness(1.2)}ul{color:#e2e8f0;display:table;margin:0 auto 10px;text-align:left}hr{border:1px solid rgba(6,182,212,.3);order:997;width:100%}select{width:92.5%}.il,select{background-color:#f0f9ff}.il{align-self:self-start;border:2px solid #e0f2fe;border-radius:6px;bottom:-5px;color:#0891b2;font-size:13.5px;font-weight:600;left:5%;padding:2px 10px 0;position:relative;transition:.3s}.il:hover{background-color:#cffafe;border-color:#06b6d4}.ei{color:#e2e8f0;margin-bottom:12px;text-align:center}.rw{align-items:baseline;display:flex;flex-wrap:nowrap;gap:20px}.loading{color:#06b6d4;font-weight:600;text-align:center}.loader{height:auto;overflow:hidden;position:relative}.spinH{background:#06b6d4;border-radius:100%;box-shadow:0 0 8px #06b6d4;height:8px;position:absolute;top:50%;width:8px}.spin-1H{animation:spinnerH 3s linear infinite}.spin-2H{animation:spinnerH 3s linear .1s infinite}.spin-3H{animation:spinnerH 3s linear .2s infinite}.spin-4H{animation:spinnerH 3s linear .3s infinite}@keyframes spinnerH{0%{transform:translateX(0)}20%{transform:translate(200px)}70%{transform:translateX(505px)}to{transform:translateX(800px)}}.pw1{background:rgba(6,182,212,.1);border:2px solid #06b6d4;border-radius:8px;font-size:20px;height:25px;margin:20px auto;position:relative;text-align:center;transition:.4s;width:80%}.pw1:not(.active){background:rgba(6,182,212,.05);cursor:pointer}.pw1 .progress{background:linear-gradient(90deg,#06b6d4,#0891b2);opacity:0;transition:.3s;width:0;z-index:5}.pw1.active .progress{animation:progress-anim 10s ease 0s;opacity:1}.pw1[data-progress-style=fill-back] .progress{bottom:0;left:0;position:absolute;right:0;top:0}.d-modal{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border:2px solid #06b6d4;border-radius:12px;box-shadow:0 8px 32px rgba(6,182,212,.3);flex-direction:column;min-width:400px;position:relative}.d-modal:focus{outline:none}#modal-message{align-items:center;display:none;inset:0;justify-content:center;position:fixed;z-index:1000}#modal-message[open]{display:flex}#modal-message:before{backdrop-filter:blur(1px);background:rgba(0,0,0,.35);content:"";inset:0;position:fixed;z-index:-1}.d-modal-title{color:#0f172a;font-weight:600;padding:1.5em;position:relative;width:calc(100% - 4.5em)}.d-modal-content{border-top:2px solid #06b6d4;color:#0f172a;overflow:auto;padding:1.5em}.topnav{align-self:flex-end;background:linear-gradient(135deg,#0f172a,#1e3a5f);border:2px solid #06b6d4;border-radius:8px}.topnav a{color:#e2e8f0;float:left;font-size:16px;padding:6px 12px}.topnav a:hover{color:#06b6d4}.topnav a.active{background:linear-gradient(180deg,#06b6d4,#026881);color:#fff;font-weight:600}.topnav .icon{display:none}.logo{width:100%}.lbl-wifi{align-self:flex-end;color:#e2e8f0}.table{border-collapse:collapse;border-spacing:0;margin:auto;width:90%}.svg{display:flex;margin-right:10px;width:20px}.svg-e{margin-top:5px}.output{color:#e2e8f0}.form{padding:10px 0;text-align:center;width:85%}.ctn:after,.ctn:before{content:" ";display:table;grid-column-end:2;grid-column-start:1;grid-row-end:2;grid-row-start:1}.ctn:after{clear:both}.ctn{background:linear-gradient(135deg,rgba(224,242,254,.65),rgba(240,249,255,.95));border:1px solid #06b6d4;border-radius:12px;box-shadow:0 8px 24px rgba(6,182,212,.2);display:flex;flex-direction:column;margin:0 auto 6px;max-width:840px;overflow:visible;padding:8px 40px;position:relative}.bb{grid-column-gap:30px;grid-row-gap:20px;display:flex;flex-wrap:wrap;justify-content:center;order:998;padding:10px}.tw{flex-direction:column;margin-bottom:10px}.sw,.tw{align-items:center;display:flex}.sw{background-color:#f0f9ff;border-radius:8px;gap:14px;width:92.5%}.sw .slider{appearance:none;background:#e2e8f0;border-radius:999px;box-shadow:inset 0 1px 2px rgba(15,23,42,.12);height:10px;margin-left:20px;outline:none;transition:box-shadow .2s,background .2s;width:100%}.sw .slider:hover{box-shadow:0 0 0 3px rgba(6,182,212,.15),inset 0 1px 2px rgba(15,23,42,.12)}.sw .slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;background:linear-gradient(135deg,#06b6d4,#0891b2);border:2px solid #e0f2fe;border-radius:50%;box-shadow:0 2px 6px rgba(6,182,212,.4);cursor:pointer;height:20px;width:20px}.sw .slider:active::-webkit-slider-thumb{filter:brightness(1.05)}.sw .slider::-moz-range-track{background:#e2e8f0;border:none;border-radius:999px;height:10px}.sw .slider::-moz-range-thumb{background:linear-gradient(135deg,#06b6d4,#0891b2);border:2px solid #e0f2fe;border-radius:50%;box-shadow:0 2px 6px rgba(6,182,212,.4);cursor:pointer;height:20px;width:20px}.sw .sr{border:none;height:40px;text-align:center;width:60px}.sw .sr:hover{border-color:#06b6d4;box-shadow:0 0 12px rgba(6,182,212,.2)}.title{display:flex;margin:-10px 0 -14px}.heading{color:#0891b2;text-align:right;width:100%}.h2{color:#0891b2;font-weight:600;margin:0 auto}.toggle{cursor:pointer;display:block;margin:0 0 18px -10px;padding:4px;width:fit-content}.tl{color:#0f172a;font-weight:500;margin:0 20px;position:relative;top:2px}.ts{background:#cbd5e1;border-radius:16px;display:inline-block;height:32px;position:relative;transition:background .25s;vertical-align:middle;width:58px}.ts:after,.ts:before{content:""}.ts:before{background:linear-gradient(180deg,#fff 0,#f0f9ff);border-radius:50%;box-shadow:0 0 0 1px rgba(6,182,212,.3);display:block;height:24px;left:4px;position:absolute;top:4px;transition:left .25s;width:24px}.toggle:hover .ts:before{background:linear-gradient(180deg,#cffafe 0,#a5f3fc);box-shadow:0 0 0 1px rgba(6,182,212,.6)}.t-check:checked+.ts{background:linear-gradient(135deg,#06b6d4,#0891b2);box-shadow:0 0 12px rgba(6,182,212,.4)}.t-check:checked+.ts:before{background:linear-gradient(180deg,#f0f9ff 0,#e0f2fe);left:30px}.t-check{position:absolute;visibility:hidden}.pswd{align-items:center;display:flex;flex-direction:row;justify-content:center;width:100%}.shw{color:#06b6d4;cursor:pointer;position:absolute;right:8%;transition:.3s}.shw:hover{color:#0891b2}.firmware{align-items:center;display:flex;flex-direction:column}.fwu{background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:8px;box-shadow:0 4px 12px rgba(6,182,212,.3);color:#fff;cursor:pointer;display:inline-block;font-weight:600;margin-bottom:20px;padding:12px 20px;transition:.3s}.fwu:hover{box-shadow:0 6px 16px rgba(6,182,212,.4)}.btn,.submit{min-width:25%}#update-log{position:relative;z-index:99}#about{color:#cbd5e1;transition:.3s}#about:hover{color:#06b6d4}#esp-ip{color:#e2e8f0;display:inline-block;margin-bottom:5px}@media screen and (max-width:991px){.wifi-connect{padding-left:20px;padding-right:20px}}@media screen and (max-width:767px){.wifi-connect{padding-left:10px;padding-right:10px}select{width:93.5%}}@media screen and (max-width:608px){h1{font-size:24px}.bb{flex-direction:column;margin-top:20px}.topnav{flex-wrap:wrap;margin-bottom:5px;max-width:calc(100% - 20px);right:10px;width:auto}.topnav a{min-width:auto;padding:5px 12px}.topnav a:not(.active){display:none}.topnav a.icon{display:block;float:right}.topnav.responsive{flex-direction:column;width:auto}.topnav.responsive .icon{display:none;position:static}.topnav.responsive a{display:block;float:none;text-align:left;width:100%}.ht{display:none}.tl{margin:0 5px}.shw{right:10%}}@media screen and (max-width:479px){body{padding:2px}select{width:95.5%}.h2{margin-top:10px;padding:0}.form{padding:0}.ctn{max-width:100%;padding:0 10px}.shw{right:3%}}.hide{display:none}.smi{margin:-2px}.cn{color:#06b6d4;font-size:12px;margin-right:15px}.un{color:#0891b2}summary{display:none}.bb.compact{grid-column-gap:12px;padding:8px 0 0}.btn.small{min-width:auto;padding:8px 12px}.cred-tabs{align-items:flex-end;display:flex;flex-wrap:nowrap;gap:0;justify-content:flex-start;margin:10px 0 0;padding-left:0}.cred-tab{background:#1e3a5f;border:2px solid #1f22236e;border-radius:8px 8px 0 0;box-shadow:none;color:#8f9195;cursor:pointer;font-size:14px;margin-right:4px;max-width:150px;min-width:0;overflow:hidden;padding:8px 12px;position:relative;text-align:center;text-overflow:ellipsis;top:2px;transition:background .2s}.cred-tab:hover{background:#0f172a}.cred-tab.active{background:#e0f2fe;border:2px solid #06b6d4;border-bottom-color:#e0f2fe;color:#0891b2;z-index:2}.cred-tabs select{background:#e0f2fe;border:2px solid #06b6d4;border-bottom-color:#e0f2fe;border-radius:8px 8px 0 0;color:#0891b2;font-weight:600;height:42px;margin:0;padding-left:12px;width:100%}#wifi,#wt{background:#e0f2fe;border:2px solid #06b6d4;border-radius:0 8px 8px 8px;margin-bottom:10px;padding:20px;position:relative;z-index:1}.tw.ic{align-items:center;flex-direction:row;justify-content:space-between;width:100%}.tw.ic .toggle{margin:10px 0 10px 30px}.bb.compact{grid-column-gap:10px;grid-row-gap:8px;display:inline-flex;justify-content:flex-start;margin-top:0;padding:0}.btn.small{background:linear-gradient(135deg,#ef4444,#b91c1c);border-radius:6px;box-shadow:none;font-size:13px;justify-content:center;min-width:120px;padding:6px 10px;width:120px}.btn.small:hover{box-shadow:0 4px 12px rgba(239,68,68,.3)}</style>
</head>
<body>
    <main id=mb>
        <header class=ctn>
            <div class=title>
                <div id=img-logo title="Click to upload your logo file"></div>
                <div class=heading>
                  <h1 id=name-logo>ESP FS Web Server</h1>
                  <span id=esp-ip></span><br>
                  <span id=esp-mode></span> - v<span id=firmware></span>
                </div>
            </div>
            <div class=topnav id=tn>
                <span id=nl><a id=set-wifi class="a-link active" data-box=wifi-box>WiFi Setup</a></span>
                <span id=upd-link><a id=set-update class="a-link" data-box=update-box>Update & FS</a></span>
                <a class="a-link icon" id=hum-btn>
                  <div class="svg smi">
                    <span id=sm></span>
                  </div>
                </a>
            </div>
        </header>
        <div id=wifi-box class="ctn ob">
          <h2 class=h2>WiFi Credential Manager</h2>
          <div id=wifi-cred-tabs class=cred-tabs></div>
            
            <div id=wt class=hide>
                <table class=table>
                  <tbody id=wifi-list></tbody>
                </table>
                <br>
            </div>
            <div id=wifi>
                <div class=tw>
                    <label for=ssid class=il>SSID</label>
                    <div class=pswd>
                        <input type=text placeholder="Enter your WiFI SSID name" id=ssid>
                        <span class=shw id=show-hide-networks>
                            <a class="show-hide hide cn" id=show-networks>â–¼</a>
                        </span>
                    </div>
                </div>
                <div class=tw>
                    <label for=password class=il>Password</label>
                    <div class=pswd>
                      <input type=password placeholder="Enter your WiFi password" id=password autocomplete=current-password data-ms-member=password>
                      <span class=shw id=show-hpword>
                        <a class="show-hide hide" id=sp>
                          <div class=svg><span class=svg-e id=sy></span></div>
                        </a>
                        <a class="show-hide" id=hp>
                          <div class=svg><span class=svg-e id=sne></span></div>
                        </a>
                      </span>  
                    </div>
                </div>
                <div class="tw">
                  <label class="il toggle">
                    <input id=no-dhcp type=checkbox class="t-check">
                    <div class=ts></div>
                    <span class=tl>Manual configuration (no DHCP)</span>
                  </label>
                </div>
                <div class=hide id=cw> 
                  <div class="tw">
                      <label for=ip class=il>IP Address</label>
                      <input type=text placeholder="IP Address" id=ip value=192.168.0.10>
                  </div>
                  <div class="tw">
                      <label for=gateway class=il>Gateway</label>
                      <input type=text placeholder="Gateway address" id=gateway value=192.168.0.1>
                  </div>
                  <div class="tw">
                      <label for=subnet class=il>Subnet</label>
                      <input type=text placeholder="Subnet mask" id=subnet value=255.255.255.0>
                  </div>
                </div>
                    
                <div class="tw ic">
                  <div id=cred-actions-inline class="bb compact hide"></div>
                  <label class="lbl-wifi toggle">
                    <input id=persistent type=checkbox class="t-check" checked>
                    <div class=ts></div>
                    <span class=tl>Save WiFi credentials</span>
                  </label>
                </div>
            </div>
            <hr>
            <div class=bb>
                <a id=scan-wifi class="btn">
                  <div class=svg><span id=ssc></span></div>
                    <span>Scan WiFi networks</span>
                </a>
                <a id=connect-wifi class="btn">
                  <div class=svg><span id=sc></span></div>
                    <span>Connect to <span id=ssid-name>SSID</span></span>
                </a>
                <a id=swi class="btn hide">
                  <div class=svg><span id=ss2></span></div>
                    <span>Save configuration</span>
                </a>
                <a id=delete-cred class="btn hide">
                  <div class=svg><span id=sdel></span></div>
                  <span>Delete SSID</span>
                </a>
                <a id=clear-creds class="btn hide">
                  <div class=svg><span id=sclr></span></div>
                  <span>Delete All</span>
                </a>
            </div>
        </div>

        <div id=update-box class="ctn ob hide">
          <h2 class=h2>Update ESP Firmware</h2>
          <div class=tw>
            <form id=update-form class=form action=/update method=post enctype=multipart/form-data>
              <div class=firmware>
                <label for=file-input id=fw-label class=fwu>Select firmware binary file</label>
                <input id=file-input type=file>
                <a id=update-btn class="btn submit">
                  <div class=svg>
                    <svg fill=currentColor viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"></path></svg>
                  </div>
                  <span>Submit!</span>
                </a><br>
              </div>
            	<div class="pw1 hide" id=pw1 data-progress-style=fill-back>
            	  <div id=update-log></div>
            	  <div class=progress id=progress-anim></div>
            	</div>
            </form>
          </div>
          
          <h2 class=h2>Load file to ESP FileSystem</h2>
          <div class=tw>
            <form class=form action=/edit method=post enctype=multipart/form-data>
              <ul id=listing></ul>
              <label for=picker id=pick-label class=fwu>Select the folder containing your files</label>
              <input type=file id=picker name=fileList webkitdirectory multiple>
              <p class=un>N.B.: if folder name is <b>"/data"</b>, the files will be uploaded at root "/" level</p>
            </form>
          </div>
        </div>
        <hr id=btn-hr class=hide>
        <div id=btn-box class="bb hide">
            <a id=restart class="btn">
              <div class=svg><span id=sr></span></div>
                <span>Restart ESP</span>
            </a>
            <a id=save-params class="btn">
              <div class=svg><span id=ssa></span></div>
                <span>Save configuration</span>
            </a>
        </div>
    </main>
    
    <div class="loader hide" id=loader>
      <div class="loading">Loading...</div>
      <div class="spinH spin-1H"></div>
      <div class="spinH spin-2H"></div>
      <div class="spinH spin-3H"></div>
      <div class="spinH spin-4H"></div>
    </div>
    
    <details id=modal-message>
        <summary></summary>
        <div class=d-modal>
            <div class=d-modal-title><h2 id=message-title>t</h2></div>
            <div class=d-modal-content><p id=message-body></p></div>
            <div class=bb>
                <a id=ok-modal class="btn hide"><span>OK</span></a>
                <a id=close-modal class="btn"><span>Close</span></a>
            </div>
        </div>
    </details>
    <footer class=foot>
        <hr>
        <a id=about target=_blank rel=noopener></a>
    </footer>
    <script>const svgLogo='<svg fill="brown" height="120" viewBox="0 0 24 24"><path d="M5 3C3.9 3 3 3.9 3 5S2.1 7 1 7v2c1.1 0 2 .9 2 2s.9 2 2 2h2v-2H5v-1c0-1.1-.9-2-2-2 1.1 0 2-.9 2-2V5h2V3M11 3c1.1 0 2 .9 2 2s.9 2 2 2v2c-1.1 0-2 .9-2 2s-.9 2-2 2H9v-2h2v-1c0-1.1.9-2 2-2-1.1 0-2-.9-2-2V5H9V3h2m11 3v12c0 1.11-.89 2-2 2H4a2 2 0 01-2-2v-3h2v3h16V6h-2.97V4H20c1.11 0 2 .89 2 2z"/></svg>',iconLock="ðŸ”’",iconUnlock="ðŸ”“",iconScan="ðŸ“¡",iconConnect="ðŸ“¶",iconSave="ðŸ’¾",iconRestart="â†»",iconEye="ðŸµ",iconNoEye="ðŸ™ˆ",iconMenu="â˜°",iconDelete="ðŸ—‘ï¸",iconClear="âœ–";let closeCb=function(){};const port=location.port||("https:"===window.location.protocol?"443":"80"),esp=`${window.location.protocol}//${window.location.hostname}:${port}/`;let configFile,lastBox,options={},wifiCredentials=[],selectedCredentialIndex=-1;const $=e=>document.getElementById(e),hide=e=>$(e).classList.add("hide"),show=e=>$(e).classList.remove("hide"),newEl=(e,t)=>{const n=document.createElement(e);if(t&&"object"==typeof t)for(const[e,o]of Object.entries(t))n.setAttribute(e,o);return n},getParameters=()=>{let e;show("loader"),fetch(`${esp}getStatus`).then((e=>e.json())).then((t=>{$("esp-mode").innerHTML=t.mode,$("esp-ip").innerHTML=`<a href="http://${t.hostname}.local/">http://${t.hostname}.local</a><a href="${esp}"> (${t.ip})</a>`,$("firmware").innerHTML=t.firmware,$("about").innerHTML="Created with "+t.liburl,$("about").setAttribute("href",t.liburl),configFile=t.path,fetch(`${esp}${configFile}`).then((e=>e.json())).then((t=>{for(const n in t)if(t.hasOwnProperty(n)){if("name-logo"===n){$("name-logo").innerHTML=t[n].replace(/(<([^>]+)>)/gi,""),document.title=t[n].replace(/(<([^>]+)>)/gi,""),delete t[n];continue}if("img-logo"===n){e=t[n],delete t[n];continue}}e&&fetch(e).then((e=>e.text())).then((t=>setLogoBase64(e,t))),options=t,createOptionsBox(options),hide("loader")}))}))},setLogoBase64=(e,t)=>{const n=e.replace(/[^\d_]/g,"").split("_"),o=newEl("img",{class:"logo",src:`data:image/png;base64, ${t}`,style:`width:${n[0]}px;height:${n[1]}px`});$("img-logo").innerHTML="",$("img-logo").append(o),$("img-logo").setAttribute("type","number"),$("img-logo").setAttribute("title","")},addOptionsElement=e=>{const t=Object.keys(e).filter((t=>"boolean"==typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});if(0!==Object.entries(t).length){const e=newEl("div",{class:"rw"});Object.entries(t).forEach((([t,n])=>{const o=newEl("label",{class:"il toggle"}),s=newEl("input",{class:"t-check oi",type:"checkbox",id:t});s.checked=n;const i=newEl("div",{class:"ts"}),a=newEl("span",{class:"tl"});a.textContent=t,o.appendChild(s),o.appendChild(i),o.appendChild(a),addInputListener(s),e.appendChild(o)})),lastBox.appendChild(e)}const n=Object.keys(e).filter((t=>"boolean"!=typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});Object.entries(n).forEach((([e,t])=>{const n=newEl("label",{class:"il","label-for":e});n.textContent=e;let o=newEl("input",{class:"oi",type:"text",id:e});if(o.value=t,"number"==typeof t&&o.setAttribute("type","number"),"object"==typeof t)if(t.values)o=newEl("select",{id:e}),t.values.forEach((e=>{const t=newEl("option");t.textContent=e,t.value=e,o.appendChild(t)})),o.value=t.selected,lastBox.appendChild(o);else if("slider"===t.type&&"number"==typeof t.value&&"min"in t&&"max"in t&&"step"in t){const n=Math.round(t.value*(1/t.step))/(1/t.step),s=String(t.step),i=s.includes(".")?s.split(".")[1].length:0,a=newEl("input",{class:"oi slider",type:"range",id:e});a.setAttribute("step",t.step),a.setAttribute("min",t.min),a.setAttribute("max",t.max),a.value=Number(n).toFixed(i);const l=newEl("input",{class:"oi sr",type:"number",id:`${e}-readout`});l.setAttribute("step",t.step),l.setAttribute("min",t.min),l.setAttribute("max",t.max),l.value=Number(n).toFixed(i),a.addEventListener("input",(n=>{l.value=n.target.value;const o=options[e]&&"object"==typeof options[e]?options[e]:{};options[e]={...o,value:Number(n.target.value),step:t.step,min:t.min,max:t.max,type:o.type||"slider"}})),l.addEventListener("change",(n=>{const o=Number(n.target.value),s=Math.min(Math.max(o,t.min),t.max),c=Math.round(s*(1/t.step))/(1/t.step),r=Number(c).toFixed(i);a.value=r,l.value=r;const d=options[e]&&"object"==typeof options[e]?options[e]:{};options[e]={...d,value:Number(r),step:t.step,min:t.min,max:t.max,type:d.type||"slider"}}));const c=newEl("div",{class:"sw"});c.appendChild(a),c.appendChild(l),o=c}else if("number"===t.type&&"number"==typeof t.value&&"min"in t&&"max"in t&&"step"in t){const e=Math.round(t.value*(1/t.step))/(1/t.step),n=String(t.step),s=n.includes(".")?n.split(".")[1].length:0;o.setAttribute("type","number"),o.setAttribute("step",t.step),o.setAttribute("min",t.min),o.setAttribute("max",t.max),o.value=Number(e).toFixed(s)}addInputListener(o);const s=newEl("div",{class:"tw"});s.appendChild(n),s.appendChild(o),lastBox.appendChild(s),e.endsWith("-hidden")&&s.classList.add("hide")}))},createNewBox=(e,t)=>{const n=newEl("div",{class:"ctn ob hide",id:`option-box${e}`}),o=newEl("h2",{class:"h2"});o.innerHTML=t,n.appendChild(o),$("mb").appendChild(n);const s=newEl("a",{class:"a-link",id:`set-opt${e}`,"data-box":`option-box${e}`});return s.innerHTML=t,s.addEventListener("click",switchPage),$("nl").appendChild(s),n},createOptionsBox=async e=>{const t=!!e.dhcp;$("no-dhcp").checked=t,$("ip").value=e.ip_address,$("gateway").value=e.gateway,$("subnet").value=e.subnet,t&&(show("cw"),show("swi"));let n={},o="wifi-box";lastBox=$(o),Object.entries(e).forEach((([e,t],s)=>{if(e.startsWith("param-box"))addOptionsElement(n),lastBox=createNewBox(s,t),n={},o=t;else if("wifi-box"!==o){let o=!1;if(e.startsWith("img-logo")||e.startsWith("name-logo"))o=!0;else if(e.startsWith("raw-css")){const e=newEl("link",{rel:"stylesheet",href:t});document.head.appendChild(e),o=!0}else if(e.startsWith("raw-javascript")){const e=newEl("script",{src:t});document.body.appendChild(e),o=!0}else if(e.startsWith("rh")){const e=newEl("div",{class:"tw rh",id:t,"data-box":lastBox.id});lastBox.appendChild(e),fetch(t).then((e=>e.text())).then((e=>$(t).innerHTML=e)),o=!0}o||(n[e]=t)}})),0!==Object.entries(n).length&&addOptionsElement(n)},hasStoredCredentialFor=e=>wifiCredentials.some((t=>t.ssid===e)),applyCredentialToForm=e=>{$("ssid").value=e.ssid||"",$("ssid-name").textContent=e.ssid||"SSID";const t=e.ip&&e.gateway&&e.subnet&&"0.0.0.0"!==e.ip;$("no-dhcp").checked=t,t?(show("cw"),show("swi"),$("ip").value=e.ip,$("gateway").value=e.gateway,$("subnet").value=e.subnet):(hide("cw"),hide("swi")),$("password").value=""},loadCredentials=async()=>{try{const e=await fetch(`${esp}wifi/credentials`,{cache:"no-store"});if(!e.ok)return;const t=await e.json();if(!Array.isArray(t))return;if(wifiCredentials=t,selectedCredentialIndex=wifiCredentials.length?0:-1,wifiCredentials.length>1)"undefined"==typeof renderCredentialTabs&&await new Promise((e=>{const t=document.createElement("script");t.src="creds.js",t.onload=e,document.body.appendChild(t)})),renderCredentialTabs();else{const e=$("wifi-cred-tabs");e&&(e.innerHTML=""),hide("delete-cred"),hide("clear-creds"),hide("cred-actions-inline")}selectedCredentialIndex>=0&&applyCredentialToForm(wifiCredentials[selectedCredentialIndex])}catch(e){console.error("Error loading credentials:",e)}};function addInputListener(e){e.addEventListener("change",(e=>{const t=e.target;switch(t.type){case"number":{const e=t.step?Number(t.step):0;if(t.id.endsWith("-readout"))return;if(e){const n=options[t.id]&&"object"==typeof options[t.id]?options[t.id]:{};options[t.id]={...n,value:Math.round(Number(t.value)*(1/e))/(1/e),step:e,min:Number(t.getAttribute("min")),max:Number(t.getAttribute("max")),type:n&&n.type?n.type:"number"}}else options[t.id]=parseInt(t.value,10);break}case"text":options[t.id]=t.value;break;case"checkbox":options[t.id]=t.checked;break;default:"select-one"===t.type&&(options[t.id].selected=t.value)}}))}function insertKey(e,t,n,o){const s={};return Object.keys(n).forEach(((i,a)=>{a===o&&(s[e]=t),s[i]=n[i]})),s}function saveParameters(){if(Object.keys(options)[0]?.startsWith("param-box")){const e="param-box0"===Object.keys(options)[0];options={...e?{"param-box-0":options["wifi-box"]}:{"wifi-box":""},dhcp:!1,...options}}const e=$("no-dhcp").checked;if(options.dhcp=e,e){const e={ip_address:$("ip").value,gateway:$("gateway").value,subnet:$("subnet").value};Object.entries(e).forEach((([e,t],n)=>{options=insertKey(e,t,options,n+2),options[e]=t}))}const t=new Blob([JSON.stringify(options,null,2)],{type:"application/json"}),n=new FormData;n.append("data",t,"/"+configFile),fetch("/edit",{method:"POST",body:n}).then((e=>e.text())).then((()=>openModal("Save options",`<br><b>"/${configFile}"</b> saved successfully on flash memory!<br><br>`))).catch((e=>openModal("Error!",`Failed to save: ${e}`)))}function showHidePassword(){const e=$("password"),t="password"===e.type;e.type=t?"text":"password",show(t?"sp":"hp"),hide(t?"hp":"sp")}function getWiFiList(){show("loader"),fetch(`${esp}scan`).then((e=>e.json())).then((e=>{listWifi(e),hide("loader")})).catch((e=>{console.error("Error fetching WiFi list:",e),hide("loader")}))}function selectWifi(e){const t=e.currentTarget,n=t.id,o=t.cells[1].textContent;try{$(`select-${n}`).checked=!0}catch(e){$(n).checked=!0}$("ssid").value=o,$("ssid-name").textContent=o,$("password").focus(),$("wt").classList.add("hide"),show("show-networks")}function listWifi(e){e.reload&&setTimeout(getWiFiList,2e3),e.sort(((e,t)=>t.strength-e.strength));const t=document.querySelector("#wifi-list");t.innerHTML="";const n=document.createDocumentFragment();e.forEach(((e,t)=>{const o=newEl("tr",{id:`wifi-${t}`});o.addEventListener("click",selectWifi),o.innerHTML=`\n      <td><input type="radio" name="select" id="select-wifi-${t}"></td>\n      <td id="ssid-wifi-${t}">${e.ssid}</td>\n      <td class="ht">${e.strength} dBm</td>\n      <td>${e.security?"ðŸ”’":"ðŸ”“"}</td>\n    `,n.appendChild(o)})),t.appendChild(n),show("wt")}function doConnection(e,t){const n=$("ssid").value,o=$("password").value,s=hasStoredCredentialFor(n);if(!n||!o&&!s)return void openModal("Connect to WiFi","Please insert a SSID and a Password, or select a saved network.");const i=new FormData;i.append("ssid",n),i.append("password",o),i.append("persistent",$("persistent").checked),t&&i.append("newSSID",!0),$("no-dhcp").checked&&(i.append("ip_address",$("ip").value),i.append("gateway",$("gateway").value),i.append("subnet",$("subnet").value));const a={method:"POST",body:i,redirect:"follow"};show("loader");const l=()=>{startConnectPolling(n)};fetch("/connect",a).then((e=>e.text().then((t=>({status:e.status,data:t}))))).then((({status:t,data:n})=>{if(200===t){if(n.includes("already"))return stopConnectPolling(),openModal("Connect to WiFi",n,(()=>doConnection(e,!0))),void hide("loader");l(),loadCredentials()}else stopConnectPolling(),openModal("Error!",n),hide("loader")})).catch((()=>{l()}))}let connectPollTimer=null;const CONNECT_POLL_INTERVAL=2e3,CONNECT_POLL_MAX_TRIES=40;function stopConnectPolling(){connectPollTimer&&(clearTimeout(connectPollTimer),connectPollTimer=null)}function startConnectPolling(e){stopConnectPolling();let t=0;const n=window.location.hostname;openModal("Connect to WiFi",`Connecting to <b>${e}</b>...<br>Trying to reach the device on the new network.`);const o=()=>{t++,fetch(`http://${n}.local/getStatus`,{cache:"no-store"}).then((e=>e.json())).then((s=>{if((s.mode||"").includes(e)){stopConnectPolling(),hide("loader");const t=`http://${n}.local/`;openModal("Connect to WiFi",`Connected to <b>${e}</b>.<br><a href="${t}">${t}</a> (IP: ${s.ip})`)}else t<40?connectPollTimer=setTimeout(o,2e3):(stopConnectPolling(),hide("loader"),openModal("Connect to WiFi","Timeout while waiting for connection. Check your router or serial log for the new IP."))})).catch((()=>{t<40?connectPollTimer=setTimeout(o,2e3):(stopConnectPolling(),hide("loader"),openModal("Connect to WiFi","Timeout while waiting for connection. Check your router or serial log for the new IP."))}))};o()}function switchPage(e){const t=e.target,n=t.getAttribute("data-box");$("tn").classList.remove("responsive"),document.querySelectorAll("a").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.querySelectorAll(".ob").forEach((e=>e.classList.add("hide"))),show(n);if("set-wifi"===t.id)hide("btn-box"),hide("btn-hr");else{const e=$(n),t=document.createDocumentFragment();t.appendChild($("btn-hr")),t.appendChild($("btn-box")),e.appendChild(t),document.querySelectorAll(".rh").forEach((t=>{t.getAttribute("data-box")===e.id&&e.insertBefore(t,$("btn-hr"))})),show("btn-box"),show("btn-hr")}}function showMenu(){$("tn").classList.toggle("responsive")}function openModal(e,t,n){const o=$("modal-message"),s=$("mb");$("message-title").innerHTML=e,$("message-body").innerHTML=t,o.open=!0,s.style.filter="blur(3px)",n?(closeCb=n,show("ok-modal")):hide("ok-modal")}function closeModal(e){$("modal-message").open=!1,$("mb").style.filter="",closeCb&&e&&closeCb()}function confirmRestart(){openModal("Restart ESP","<br>Do you want to restart now?",restartESP)}function restartESP(){fetch(`${esp}reset`).then((()=>{closeModal(),openModal("Restart!","<br>ESP restarted!")})).catch((e=>openModal("Error!",`Failed to restart ESP: ${e}`)))}function handleSubmit(){const e=$("file-input").files;if(0===e.length)return void alert("Please choose a file");const t=$("update-log"),n=$("pw1"),o=$("progress-anim");show("loader"),show("pw1"),n.classList.add("active"),t.innerHTML="Update in progress";const s=new FormData;s.set("update",e[0]);const i=new XMLHttpRequest;i.open("POST",`/update?size=${e[0].size}`),i.onload=()=>{hide("loader"),n.classList.remove("active"),t.innerHTML=200===i.status?i.response:`Error ${i.status}: ${i.statusText}`},i.upload.addEventListener("progress",(e=>{if(e.lengthComputable){const n=`${Math.round(e.loaded/e.total*100)}%`;o.style.width=n,t.innerHTML=`Update in progress: ${n}`}})),i.send(s)}async function uploadFolder(e){const t=$("listing"),n=async(e,n)=>{const o=newEl("li");o.textContent=n,t.appendChild(o);try{const t=new FormData;t.set("data",e,"/"+n);if(!(await fetch("/edit",{method:"POST",body:t})).ok)throw new Error("Upload failed")}catch(e){console.error(`Error uploading ${n}:`,e),o.style.color="red"}};for(const t of e.target.files){const e=t.webkitRelativePath.replace(/^data\//,"");await n(t,e)}}const uiIcons={"sm":"â˜°","sy":"ðŸµ","sne":"ðŸ™ˆ","ssc":"ðŸ“¡","sc":"ðŸ“¶","ssa":"ðŸ’¾","ss2":"ðŸ’¾","sr":"â†»","sdel":"ðŸ—‘ï¸","sclr":"âœ–"};Object.entries(uiIcons).forEach((([e,t])=>{const n=$(e);n&&(n.textContent=t)}));const logoEl=$("img-logo");logoEl&&(logoEl.innerHTML=svgLogo);const eventListeners={"hum-btn":["click",showMenu],"scan-wifi":["click",getWiFiList],"connect-wifi":["click",doConnection],"save-params":["click",saveParameters],"swi":["click",saveParameters],"delete-cred":["click",()=>window.deleteSelectedCredential&&window.deleteSelectedCredential()],"clear-creds":["click",()=>window.clearAllCredentials&&window.clearAllCredentials()],"show-hpword":["click",showHidePassword],"set-wifi":["click",switchPage],"set-update":["click",switchPage],about:["click",switchPage],restart:["click",confirmRestart],picker:["change",uploadFolder],"update-btn":["click",handleSubmit],"ok-modal":["click",()=>closeModal(!0)],"close-modal":["click",()=>closeModal(!1)]};Object.entries(eventListeners).forEach((([e,[t,n]])=>{$(e).addEventListener(t,n)})),$("file-input").addEventListener("change",(()=>{const e=$("file-input").files[0];$("fw-label").innerHTML=`${e.name} (${e.size} bytes)`,$("fw-label").style.background="brown"})),$("no-dhcp").addEventListener("change",(function(){const e=this.checked?"remove":"add";["cw","swi"].forEach((t=>$(t).classList[e]("hide")))})),$("ssid")&&$("ssid").addEventListener("input",(function(){$("ssid-name").textContent=this.value||"SSID"})),$("show-networks")&&$("show-networks").addEventListener("click",(()=>{$("wt").classList.toggle("hide"),$("show-networks").classList.toggle("hide")})),window.addEventListener("load",(()=>{getParameters(),loadCredentials();const e=$("cred-actions-inline");if(e){const t=$("delete-cred"),n=$("clear-creds");t&&n&&(t.classList.add("small"),n.classList.add("small"),e.appendChild(t),e.appendChild(n))}}));</script>
</body>
</html>