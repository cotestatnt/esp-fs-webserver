const svgLogo='<svg fill="brown" height="120" viewBox="0 0 24 24"><path d="M5 3C3.9 3 3 3.9 3 5S2.1 7 1 7v2c1.1 0 2 .9 2 2s.9 2 2 2h2v-2H5v-1c0-1.1-.9-2-2-2 1.1 0 2-.9 2-2V5h2V3M11 3c1.1 0 2 .9 2 2s.9 2 2 2v2c-1.1 0-2 .9-2 2s-.9 2-2 2H9v-2h2v-1c0-1.1.9-2 2-2-1.1 0-2-.9-2-2V5H9V3h2m11 3v12c0 1.11-.89 2-2 2H4a2 2 0 01-2-2v-3h2v3h16V6h-2.97V4H20c1.11 0 2 .89 2 2z"/></svg>',svgLock='<svg height="16" viewBox="0 0 24 24"><path d="M12 17a2 2 0 002-2c0-1.11-.9-2-2-2a2 2 0 00-2 2 2 2 0 002 2m6-9a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V10c0-1.11.9-2 2-2h1V6a5 5 0 0110 0v2h1M12 3a3 3 0 00-3 3v2h6V6a3 3 0 00-3-3z"/></svg>',svgUnlock='<svg height="16" viewBox="0 0 24 24"><path d="M18 1c-2.76 0-5 2.24-5 5v2H4c-1.1 0-2 .89-2 2v10c0 1.11.9 2 2 2h12c1.11 0 2-.89 2-2V10c0-1.1-.89-2-2-2h-1V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2h2V6c0-2.76-2.24-5-5-5M10 13c1.1 0 2 .89 2 2 0 1.11-.9 2-2 2s-2-.89-2-2c0-1.1.9-2 2-2z"/></svg>',svgScan='<path d="M12 20l-3.6-4.8c1 .75 2.25 1.2 3.6 1.2s2.6-.45 3.6-1.2L12 20M4.8 10.4l1.8 2.4C8.1 11.67 10 11 12 11s3.9.67 5.4 1.8l1.8-2.4C17.19 8.89 14.7 8 12 8s-5.19.89-8.2 2.4M12 2a10 10 0 00-10.8 3.6L3 8c2.5-1.88 5.62-3 9-3s6.5 1.12 9 3l1.8-2.4C19.79 3.34 16.05 2 12 2M7 24h2v-2H7v2m8 0h2v-2h-2v2m-4 0h2v-2h-2v2z"/>',svgConnect='<path d="M12 21l3.6-4.8c-1-.75-2.25-1.2-3.6-1.2s-2.6.45-3.6 1.2L12 21M12 3C7.95 3 4.21 4.34 1.2 6.6L3 9c2.5-1.88 5.62-3 9-3s6.5 1.12 9 3l1.8-2.4C19.79 4.34 16.05 3 12 3m0 6c-2.7 0-5.19.89-7.2 2.4l1.8 2.4c1.5-1.13 3.37-1.8 5.4-1.8s3.9.67 5.4 1.8l1.8-2.4C17.19 9.89 14.7 9 12 9z"/>',svgSave='<path d="M15 9H5V5h10m-3 10a3 3 0 01-3-3 3 3 0 013-3 3 3 0 013 3 3 3 0 01-3 3m8-16H5c-1.11 0-2 .9-2 2v14a2 2 0 002 2h14a2 2 0 002-2V7l-4-4z"/>',svgRestart='<path d="M12 4a8 8 0 015.6 2.3C20.7 9.4 20.7 14.5 17.6 17.6a8 8 0 01-6.7 2.3l.5-2a6 6 0 004.8-1.7c2.3-2.3 2.3-6.1 0-8.5a6 6 0 00-4.2-1.7V10.6L7 5.6 12 .6V4M6.3 17.6C3.7 15 3.3 11 5.1 7.9l1.5 1.5A6 6 0 007.8 16.2c.5.5 1.1.9 1.8 1.2l-.6 2a8 8 0 01-2.7-1.8z"/>',svgEye='<path d="M12 9a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5s-9.27-3.11-11-7.5C2.73 7.61 7 4.5 12 4.5M3.18 12a9.821 9.821 0 0017.64 0A9.821 9.821 0 003.18 12z"/>',svgNoEye='<path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>',svgMenu='<path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/>',svgDelete='<path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6Z"/>',svgClear='<path d="M5,5V7H19V5H5M7,9V11H17V9H7M9,13V15H15V13H9M11,17V19H13V17H11Z"/>';let closeCb=function(){};const port=location.port||("https:"===window.location.protocol?"443":"80"),esp=`${window.location.protocol}//${window.location.hostname}:${port}/`;let configFile,lastBox,options={},wifiCredentials=[],selectedCredentialIndex=-1;const $=e=>document.getElementById(e),hide=e=>$(e).classList.add("hide"),show=e=>$(e).classList.remove("hide"),newEl=(e,t)=>{const n=document.createElement(e);if(t&&"object"==typeof t)for(const[e,s]of Object.entries(t))n.setAttribute(e,s);return n},getParameters=()=>{let e;show("loader"),fetch(`${esp}getStatus`).then((e=>e.json())).then((t=>{$("esp-mode").innerHTML=t.mode,$("esp-ip").innerHTML=`<a href="http://${t.hostname}.local/">http://${t.hostname}.local</a><a href="${esp}"> (${t.ip})</a>`,$("firmware").innerHTML=t.firmware,$("about").innerHTML="Created with "+t.liburl,$("about").setAttribute("href",t.liburl),configFile=t.path,fetch(`${esp}${configFile}`).then((e=>e.json())).then((t=>{for(const n in t)if(t.hasOwnProperty(n)){if("name-logo"===n){$("name-logo").innerHTML=t[n].replace(/(<([^>]+)>)/gi,""),document.title=t[n].replace(/(<([^>]+)>)/gi,""),delete t[n];continue}if("img-logo"===n){e=t[n],delete t[n];continue}}e&&fetch(e).then((e=>e.text())).then((t=>setLogoBase64(e,t))),options=t,createOptionsBox(options),hide("loader")}))}))},setLogoBase64=(e,t)=>{const n=e.replace(/[^\d_]/g,"").split("_"),s=newEl("img",{class:"logo",src:`data:image/png;base64, ${t}`,style:`width:${n[0]}px;height:${n[1]}px`});$("img-logo").innerHTML="",$("img-logo").append(s),$("img-logo").setAttribute("type","number"),$("img-logo").setAttribute("title","")},addOptionsElement=e=>{const t=Object.keys(e).filter((t=>"boolean"==typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});if(0!==Object.entries(t).length){const e=newEl("div",{class:"row-wrapper"});Object.entries(t).forEach((([t,n])=>{const s=newEl("label",{class:"input-label toggle"}),o=newEl("input",{class:"t-check opt-input",type:"checkbox",id:t});o.checked=n;const i=newEl("div",{class:"toggle-switch"}),a=newEl("span",{class:"toggle-label"});a.textContent=t,s.appendChild(o),s.appendChild(i),s.appendChild(a),addInputListener(o),e.appendChild(s)})),lastBox.appendChild(e)}const n=Object.keys(e).filter((t=>"boolean"!=typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});Object.entries(n).forEach((([e,t])=>{const n=newEl("label",{class:"input-label","label-for":e});n.textContent=e;let s=newEl("input",{class:"opt-input",type:"text",id:e});if(s.value=t,"number"==typeof t&&s.setAttribute("type","number"),"object"==typeof t)if(t.values)s=newEl("select",{id:e}),t.values.forEach((e=>{const t=newEl("option");t.textContent=e,t.value=e,s.appendChild(t)})),s.value=t.selected,lastBox.appendChild(s);else if("slider"===t.type&&"number"==typeof t.value&&"min"in t&&"max"in t&&"step"in t){const n=Math.round(t.value*(1/t.step))/(1/t.step),o=String(t.step),i=o.includes(".")?o.split(".")[1].length:0,a=newEl("input",{class:"opt-input slider",type:"range",id:e});a.setAttribute("step",t.step),a.setAttribute("min",t.min),a.setAttribute("max",t.max),a.value=Number(n).toFixed(i);const l=newEl("input",{class:"opt-input slider-readout",type:"number",id:`${e}-readout`});l.setAttribute("step",t.step),l.setAttribute("min",t.min),l.setAttribute("max",t.max),l.value=Number(n).toFixed(i),a.addEventListener("input",(n=>{l.value=n.target.value;const s=options[e]&&"object"==typeof options[e]?options[e]:{};options[e]={...s,value:Number(n.target.value),step:t.step,min:t.min,max:t.max,type:s.type||"slider"}})),l.addEventListener("change",(n=>{const s=Number(n.target.value),o=Math.min(Math.max(s,t.min),t.max),c=Math.round(o*(1/t.step))/(1/t.step),r=Number(c).toFixed(i);a.value=r,l.value=r;const d=options[e]&&"object"==typeof options[e]?options[e]:{};options[e]={...d,value:Number(r),step:t.step,min:t.min,max:t.max,type:d.type||"slider"}}));const c=newEl("div",{class:"slider-wrapper"});c.appendChild(a),c.appendChild(l),s=c}else if("number"===t.type&&"number"==typeof t.value&&"min"in t&&"max"in t&&"step"in t){const e=Math.round(t.value*(1/t.step))/(1/t.step),n=String(t.step),o=n.includes(".")?n.split(".")[1].length:0;s.setAttribute("type","number"),s.setAttribute("step",t.step),s.setAttribute("min",t.min),s.setAttribute("max",t.max),s.value=Number(e).toFixed(o)}addInputListener(s);const o=newEl("div",{class:"tf-wrapper"});o.appendChild(n),o.appendChild(s),lastBox.appendChild(o),e.endsWith("-hidden")&&o.classList.add("hide")}))},createNewBox=(e,t)=>{const n=newEl("div",{class:"ctn opt-box hide",id:`option-box${e}`}),s=newEl("h2",{class:"heading-2"});s.innerHTML=t,n.appendChild(s),$("main-box").appendChild(n);const o=newEl("a",{class:"a-link",id:`set-opt${e}`,"data-box":`option-box${e}`});return o.innerHTML=t,o.addEventListener("click",switchPage),$("nav-link").appendChild(o),n},createOptionsBox=async e=>{const t=!!e.dhcp;$("no-dhcp").checked=t,$("ip").value=e.ip_address,$("gateway").value=e.gateway,$("subnet").value=e.subnet,t&&(show("conf-wifi"),show("save-wifi"));let n={},s="wifi-box";lastBox=$(s),Object.entries(e).forEach((([e,t],o)=>{if(e.startsWith("param-box"))addOptionsElement(n),lastBox=createNewBox(o,t),n={},s=t;else if("wifi-box"!==s){let s=!1;if(e.startsWith("img-logo")||e.startsWith("name-logo"))s=!0;else if(e.startsWith("raw-css")){const e=newEl("link",{rel:"stylesheet",href:t});document.head.appendChild(e),s=!0}else if(e.startsWith("raw-javascript")){const e=newEl("script",{src:t});document.body.appendChild(e),s=!0}else if(e.startsWith("raw-html")){const e=newEl("div",{class:"tf-wrapper raw-html",id:t,"data-box":lastBox.id});lastBox.appendChild(e),fetch(t).then((e=>e.text())).then((e=>$(t).innerHTML=e)),s=!0}s||(n[e]=t)}})),0!==Object.entries(n).length&&addOptionsElement(n)},hasStoredCredentialFor=e=>wifiCredentials.some((t=>t.ssid===e)),applyCredentialToForm=e=>{$("ssid").value=e.ssid||"",$("ssid-name").textContent=e.ssid||"SSID";const t=e.ip&&e.gateway&&e.subnet&&"0.0.0.0"!==e.ip;$("no-dhcp").checked=t,t?(show("conf-wifi"),show("save-wifi"),$("ip").value=e.ip,$("gateway").value=e.gateway,$("subnet").value=e.subnet):(hide("conf-wifi"),hide("save-wifi")),$("password").value=""},loadCredentials=async()=>{try{const e=await fetch(`${esp}wifi/credentials`,{cache:"no-store"});if(!e.ok)return;const t=await e.json();if(!Array.isArray(t))return;if(wifiCredentials=t,selectedCredentialIndex=wifiCredentials.length?0:-1,wifiCredentials.length>1)"undefined"==typeof renderCredentialTabs&&await new Promise((e=>{const t=document.createElement("script");t.src="creds.js",t.onload=e,document.body.appendChild(t)})),renderCredentialTabs();else{const e=$("wifi-cred-tabs");e&&(e.innerHTML=""),hide("delete-cred"),hide("clear-creds"),hide("cred-actions-inline")}selectedCredentialIndex>=0&&applyCredentialToForm(wifiCredentials[selectedCredentialIndex])}catch(e){console.error("Error loading credentials:",e)}};function addInputListener(e){e.addEventListener("change",(e=>{const t=e.target;switch(t.type){case"number":{const e=t.step?Number(t.step):0;if(t.id.endsWith("-readout"))return;if(e){const n=options[t.id]&&"object"==typeof options[t.id]?options[t.id]:{};options[t.id]={...n,value:Math.round(Number(t.value)*(1/e))/(1/e),step:e,min:Number(t.getAttribute("min")),max:Number(t.getAttribute("max")),type:n&&n.type?n.type:"number"}}else options[t.id]=parseInt(t.value,10);break}case"text":options[t.id]=t.value;break;case"checkbox":options[t.id]=t.checked;break;default:"select-one"===t.type&&(options[t.id].selected=t.value)}}))}function insertKey(e,t,n,s){const o={};return Object.keys(n).forEach(((i,a)=>{a===s&&(o[e]=t),o[i]=n[i]})),o}function saveParameters(){if(Object.keys(options)[0]?.startsWith("param-box")){const e="param-box0"===Object.keys(options)[0];options={...e?{"param-box-0":options["wifi-box"]}:{"wifi-box":""},dhcp:!1,...options}}const e=$("no-dhcp").checked;if(options.dhcp=e,e){const e={ip_address:$("ip").value,gateway:$("gateway").value,subnet:$("subnet").value};Object.entries(e).forEach((([e,t],n)=>{options=insertKey(e,t,options,n+2),options[e]=t}))}const t=new Blob([JSON.stringify(options,null,2)],{type:"application/json"}),n=new FormData;n.append("data",t,"/"+configFile),fetch("/edit",{method:"POST",body:n}).then((e=>e.text())).then((()=>openModal("Save options",`<br><b>"/${configFile}"</b> saved successfully on flash memory!<br><br>`))).catch((e=>openModal("Error!",`Failed to save: ${e}`)))}function showHidePassword(){const e=$("password"),t="password"===e.type;e.type=t?"text":"password",show(t?"show-pass":"hide-pass"),hide(t?"hide-pass":"show-pass")}function getWiFiList(){show("loader"),fetch(`${esp}scan`).then((e=>e.json())).then((e=>{listWifi(e),hide("loader")})).catch((e=>{console.error("Error fetching WiFi list:",e),hide("loader")}))}function selectWifi(e){const t=e.currentTarget,n=t.id,s=t.cells[1].textContent;try{$(`select-${n}`).checked=!0}catch(e){$(n).checked=!0}$("ssid").value=s,$("ssid-name").textContent=s,$("password").focus(),$("wifi-table").classList.add("hide"),show("show-networks")}function listWifi(e){e.reload&&setTimeout(getWiFiList,2e3),e.sort(((e,t)=>t.strength-e.strength));const t=document.querySelector("#wifi-list");t.innerHTML="";const n=document.createDocumentFragment();e.forEach(((e,t)=>{const s=newEl("tr",{id:`wifi-${t}`});s.addEventListener("click",selectWifi),s.innerHTML=`\n      <td><input type="radio" name="select" id="select-wifi-${t}"></td>\n      <td id="ssid-wifi-${t}">${e.ssid}</td>\n      <td class="hide-tiny">${e.strength} dBm</td>\n      <td>${e.security?svgLock:svgUnlock}</td>\n    `,n.appendChild(s)})),t.appendChild(n),show("wifi-table")}function doConnection(e,t){const n=$("ssid").value,s=$("password").value,o=hasStoredCredentialFor(n);if(!n||!s&&!o)return void openModal("Connect to WiFi","Please insert a SSID and a Password, or select a saved network.");const i=new FormData;i.append("ssid",n),i.append("password",s),i.append("persistent",$("persistent").checked),t&&i.append("newSSID",!0),$("no-dhcp").checked&&(i.append("ip_address",$("ip").value),i.append("gateway",$("gateway").value),i.append("subnet",$("subnet").value));const a={method:"POST",body:i,redirect:"follow"};show("loader");const l=()=>{startConnectPolling(n)};fetch("/connect",a).then((e=>e.text().then((t=>({status:e.status,data:t}))))).then((({status:t,data:n})=>{if(200===t){if(n.includes("already"))return stopConnectPolling(),openModal("Connect to WiFi",n,(()=>doConnection(e,!0))),void hide("loader");l(),loadCredentials()}else stopConnectPolling(),openModal("Error!",n),hide("loader")})).catch((()=>{l()}))}let connectPollTimer=null;const CONNECT_POLL_INTERVAL=2e3,CONNECT_POLL_MAX_TRIES=40;function stopConnectPolling(){connectPollTimer&&(clearTimeout(connectPollTimer),connectPollTimer=null)}function startConnectPolling(e){stopConnectPolling();let t=0;const n=window.location.hostname;openModal("Connect to WiFi",`Connecting to <b>${e}</b>...<br>Trying to reach the device on the new network.`);const s=()=>{t++,fetch(`http://${n}.local/getStatus`,{cache:"no-store"}).then((e=>e.json())).then((o=>{if((o.mode||"").includes(e)){stopConnectPolling(),hide("loader");const t=`http://${n}.local/`;openModal("Connect to WiFi",`Connected to <b>${e}</b>.<br><a href="${t}">${t}</a> (IP: ${o.ip})`)}else t<40?connectPollTimer=setTimeout(s,2e3):(stopConnectPolling(),hide("loader"),openModal("Connect to WiFi","Timeout while waiting for connection. Check your router or serial log for the new IP."))})).catch((()=>{t<40?connectPollTimer=setTimeout(s,2e3):(stopConnectPolling(),hide("loader"),openModal("Connect to WiFi","Timeout while waiting for connection. Check your router or serial log for the new IP."))}))};s()}function switchPage(e){const t=e.target,n=t.getAttribute("data-box");$("top-nav").classList.remove("responsive"),document.querySelectorAll("a").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.querySelectorAll(".opt-box").forEach((e=>e.classList.add("hide"))),show(n);if("set-wifi"===t.id)hide("btn-box"),hide("btn-hr");else{const e=$(n),t=document.createDocumentFragment();t.appendChild($("btn-hr")),t.appendChild($("btn-box")),e.appendChild(t),document.querySelectorAll(".raw-html").forEach((t=>{t.getAttribute("data-box")===e.id&&e.insertBefore(t,$("btn-hr"))})),show("btn-box"),show("btn-hr")}}function showMenu(){$("top-nav").classList.toggle("responsive")}function openModal(e,t,n){const s=$("modal-message"),o=$("main-box");$("message-title").innerHTML=e,$("message-body").innerHTML=t,s.open=!0,o.style.filter="blur(3px)",n?(closeCb=n,show("ok-modal")):hide("ok-modal")}function closeModal(e){$("modal-message").open=!1,$("main-box").style.filter="",closeCb&&e&&closeCb()}function confirmRestart(){openModal("Restart ESP","<br>Do you want to restart now?",restartESP)}function restartESP(){fetch(`${esp}reset`).then((()=>{closeModal(),openModal("Restart!","<br>ESP restarted!")})).catch((e=>openModal("Error!",`Failed to restart ESP: ${e}`)))}function handleSubmit(){const e=$("file-input").files;if(0===e.length)return void alert("Please choose a file");const t=$("update-log"),n=$("progress-wrap"),s=$("progress-anim");show("loader"),show("progress-wrap"),n.classList.add("active"),t.innerHTML="Update in progress";const o=new FormData;o.set("update",e[0]);const i=new XMLHttpRequest;i.open("POST",`/update?size=${e[0].size}`),i.onload=()=>{hide("loader"),n.classList.remove("active"),t.innerHTML=200===i.status?i.response:`Error ${i.status}: ${i.statusText}`},i.upload.addEventListener("progress",(e=>{if(e.lengthComputable){const n=`${Math.round(e.loaded/e.total*100)}%`;s.style.width=n,t.innerHTML=`Update in progress: ${n}`}})),i.send(o)}async function uploadFolder(e){const t=$("listing"),n=async(e,n)=>{const s=newEl("li");s.textContent=n,t.appendChild(s);try{const t=new FormData;t.set("data",e,"/"+n);if(!(await fetch("/edit",{method:"POST",body:t})).ok)throw new Error("Upload failed")}catch(e){console.error(`Error uploading ${n}:`,e),s.style.color="red"}};for(const t of e.target.files){const e=t.webkitRelativePath.replace(/^data\//,"");await n(t,e)}}const svgIcons={"svg-menu":svgMenu,"svg-eye":svgEye,"svg-no-eye":svgNoEye,"svg-scan":svgScan,"svg-connect":svgConnect,"svg-save":svgSave,"svg-save2":svgSave,"svg-restart":svgRestart,"svg-delete":svgDelete,"svg-clear":svgClear,"img-logo":svgLogo};Object.entries(svgIcons).forEach((([e,t])=>{$(e).innerHTML=t}));const eventListeners={"hum-btn":["click",showMenu],"scan-wifi":["click",getWiFiList],"connect-wifi":["click",doConnection],"save-params":["click",saveParameters],"save-wifi":["click",saveParameters],"delete-cred":["click",()=>window.deleteSelectedCredential&&window.deleteSelectedCredential()],"clear-creds":["click",()=>window.clearAllCredentials&&window.clearAllCredentials()],"show-hide-password":["click",showHidePassword],"set-wifi":["click",switchPage],"set-update":["click",switchPage],about:["click",switchPage],restart:["click",confirmRestart],picker:["change",uploadFolder],"update-btn":["click",handleSubmit]};Object.entries(eventListeners).forEach((([e,[t,n]])=>{$(e).addEventListener(t,n)})),$("file-input").addEventListener("change",(()=>{const e=$("file-input").files[0];$("fw-label").innerHTML=`${e.name} (${e.size} bytes)`,$("fw-label").style.background="brown"})),$("no-dhcp").addEventListener("change",(function(){const e=this.checked?"remove":"add";["conf-wifi","save-wifi"].forEach((t=>$(t).classList[e]("hide")))})),$("ssid")&&$("ssid").addEventListener("input",(function(){$("ssid-name").textContent=this.value||"SSID"})),$("show-networks")&&$("show-networks").addEventListener("click",(()=>{$("wifi-table").classList.toggle("hide"),$("show-networks").classList.toggle("hide")})),window.addEventListener("load",(()=>{getParameters(),loadCredentials();const e=$("cred-actions-inline");if(e){const t=$("delete-cred"),n=$("clear-creds");t&&n&&(t.classList.add("small"),n.classList.add("small"),e.appendChild(t),e.appendChild(n))}}));