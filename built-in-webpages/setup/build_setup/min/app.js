const ICONS={lock:"ðŸ”’",unlock:"ðŸ”“",scan:"ðŸ“¡",connect:"ðŸ“¶",save:"ðŸ’¾",restart:"â†»",eye:"ðŸµ",noEye:"ðŸ™ˆ",menu:"â˜°",del:"ðŸ—‘ï¸",clear:"âœ–",upload:"âžœ"};let closeCb=()=>{};const port=location.port||("https:"===location.protocol?"443":"80"),esp=`${location.protocol}//${location.hostname}:${port}/`;let configFile,lastBox,options={},wifiCredentials=[],selectedCredentialIndex=-1;const $=e=>document.getElementById(e),hide=e=>$(e)?.classList.add("hide"),show=e=>$(e)?.classList.remove("hide"),newEl=(e,t={})=>{const n=document.createElement(e);for(const[e,s]of Object.entries(t))n.setAttribute(e,s);return n},handleInputChange=e=>{const t=e.target;if(!t.classList.contains("opt-input"))return;const n=t.id;if("range"===t.type){const e=$(`${n}-readout`);e&&(e.value=t.value),updateSliderOption(n,t.value)}else if(t.id.endsWith("-readout")){const e=n.replace("-readout",""),s=$(e);s&&(s.value=t.value,updateSliderOption(e,t.value))}else if("checkbox"===t.type)options[n]=t.checked;else if("number"===t.type){const e=t.step?Number(t.step):0;options[n]=e?parseFloat(t.value):parseInt(t.value,10)}else options[n]=t.value},updateSliderOption=(e,t)=>{const n=options[e]&&"object"==typeof options[e]?options[e]:{},s=Number(t),a=n.step||1;options[e]={...n,value:Math.round(s*(1/a))/(1/a),type:n.type||"slider"}};window.addEventListener("load",(()=>{getParameters();const e=$("logo-tpl");e&&$("img-logo").appendChild(e.content.cloneNode(!0)),$("main-box").addEventListener("change",handleInputChange),$("main-box").addEventListener("input",(e=>{if("range"===e.target.type&&e.target.classList.contains("opt-input")){const t=$(`${e.target.id}-readout`);t&&(t.value=e.target.value)}})),$("hum-btn").onclick=()=>$("top-nav").classList.toggle("responsive"),$("scan-wifi").onclick=getWiFiList,$("connect-wifi").onclick=e=>doConnection(e,!1),$("save-params").onclick=saveParameters,$("delete-cred").onclick=()=>window.deleteSelectedCredential?.(),$("clear-creds").onclick=()=>window.clearAllCredentials?.(),$("set-wifi").onclick=switchPage,$("set-update").onclick=switchPage,$("restart").onclick=confirmRestart,$("update-btn").onclick=handleUpdate,$("ok-modal").onclick=()=>closeModal(!0),$("close-modal").onclick=()=>closeModal(!1),$("show-networks").onclick=()=>{$("wifi-table").classList.toggle("hide"),$("show-networks").classList.toggle("hide")},$("show-hide-password").onclick=()=>{const e=$("password"),t="password"===e.type;e.type=t?"text":"password",t?(show("show-pass"),hide("hide-pass")):(hide("show-pass"),show("hide-pass"))},$("ssid")&&$("ssid-name")&&$("ssid").addEventListener("input",(()=>{const e=$("ssid").value.trim();$("ssid-name").textContent=e||"SSID"})),$("dhcp").onchange=function(){const e=this.checked?"add":"remove";["conf-wifi"].forEach((t=>$(t)?.classList[e]("hide")))},$("picker").onchange=uploadFolder;const t=$("fw-label");t&&!t.dataset.defaultText&&(t.dataset.defaultText=t.textContent);const n=$("pick-label");n&&!n.dataset.defaultText&&(n.dataset.defaultText=n.textContent),$("update-btn")&&$("update-btn").setAttribute("aria-disabled","true"),$("file-input").onchange=function(){const e=$("fw-label");if(!this.files||!this.files.length||!e)return;const t=this.files[0],n=`${t.size} bytes`;e.textContent=`${t.name} (${n})`,e.title=t.name,e.style.background="brown",$("update-btn")&&$("update-btn").setAttribute("aria-disabled","false")};const s={"svg-menu":ICONS.menu,"svg-eye":ICONS.eye,"svg-no-eye":ICONS.noEye,"svg-scan":ICONS.scan,"svg-connect":ICONS.connect,"svg-save":ICONS.save,"svg-save2":ICONS.save,"svg-restart":ICONS.restart,"svg-delete":ICONS.del,"svg-clear":ICONS.clear,"svg-update":ICONS.upload};for(const[e,t]of Object.entries(s))$(e)&&($(e).textContent=t)}));const getParameters=()=>{show("loader"),fetch(`${esp}getStatus`).then((e=>e.json())).then((e=>{$("esp-mode").innerHTML=e.mode,$("esp-ip").innerHTML=`<a href="http://${e.hostname}.local/">http://${e.hostname}.local</a><a href="${esp}"> (${e.ip})</a>`,$("firmware").innerHTML=e.firmware,$("about").href=e.liburl,$("about").innerHTML="Created with "+e.liburl,configFile=e.path,fetch(`${esp}${configFile}`).then((e=>e.json())).then((e=>{if(e["img-logo"]){const t=e["img-logo"];fetch(t).then((e=>e.text())).then((e=>{const n=t.replace(/[^\d_]/g,"").split("_"),s=newEl("img",{class:"logo",src:`data:image/png;base64,${e}`,style:`width:${n[0]||64}px;height:${n[1]||64}px`});$("img-logo").innerHTML="",$("img-logo").appendChild(s)})),delete e["img-logo"]}if(e["name-logo"]){const t=e["name-logo"].replace(/(<([^>]+)>)/gi,"");$("name-logo").innerHTML=t,document.title=t,delete e["name-logo"]}options=e,createOptionsBox(options),hide("loader"),loadCredentials()}))}))},addOptionsElement=e=>{const t=document.createDocumentFragment(),n=Object.entries(e).filter((([e,t])=>"boolean"==typeof t));if(n.length>0){const e=newEl("div",{class:"row-wrapper"});n.forEach((([t,n])=>{const s=newEl("label",{class:"input-label toggle"}),a=newEl("input",{class:"t-check opt-input",type:"checkbox",id:t});a.checked=n,s.append(a,newEl("div",{class:"toggle-switch"}),newEl("span",{class:"toggle-label"})),s.lastChild.textContent=t,e.appendChild(s)})),t.appendChild(e)}Object.entries(e).forEach((([e,n])=>{if("boolean"==typeof n)return;const s=newEl("div",{class:"tf-wrapper"}),a=newEl("label",{class:"input-label"});let o;if(a.textContent=e,"object"==typeof n&&n.values)o=newEl("select",{id:e,class:"opt-input"}),n.values.forEach((e=>{const t=newEl("option",{value:e});t.textContent=e,e===n.selected&&(t.selected=!0),o.appendChild(t)}));else if("object"==typeof n&&"slider"===n.type){const t=newEl("div",{class:"slider-wrapper"}),s=newEl("input",{class:"opt-input slider",type:"range",id:e,min:n.min,max:n.max,step:n.step});s.value=n.value;const a=newEl("input",{class:"opt-input slider-readout",type:"number",id:`${e}-readout`,min:n.min,max:n.max,step:n.step});a.value=n.value,t.append(s,a),o=t}else"object"==typeof n&&"number"===n.type?(o=newEl("input",{class:"opt-input",type:"number",id:e,min:n.min,max:n.max,step:n.step}),o.value=n.value):(o=newEl("input",{class:"opt-input",type:"number"==typeof n?"number":"text",id:e}),o.value=n);s.append(a,o),e.endsWith("-hidden")&&s.classList.add("hide"),t.appendChild(s)})),lastBox.appendChild(t)},createNewBox=(e,t)=>{const n=newEl("div",{class:"ctn opt-box hide",id:`option-box${e}`}),s=newEl("h2",{class:"heading-2"});s.textContent=t,n.appendChild(s),$("main-box").appendChild(n);const a=newEl("a",{class:"a-link",id:`set-opt${e}`,"data-box":`option-box${e}`});return a.textContent=t,a.onclick=switchPage,$("nav-link").appendChild(a),n},createOptionsBox=e=>{const t=!e.hasOwnProperty("dhcp")||e.dhcp;$("dhcp").checked=t,["ip","gateway","subnet"].forEach((t=>$(t).value=e["ip"===t?"ip_address":t]||""));const n=t?"add":"remove";["conf-wifi"].forEach((e=>$(e)?.classList[n]("hide")));let s={},a="wifi-box";lastBox=$(a),Object.entries(e).forEach((([e,t],n)=>{if(e.startsWith("param-box"))Object.keys(s).length&&addOptionsElement(s),lastBox=createNewBox(n,t),s={},a=t;else if("wifi-box"!==a)if(e.startsWith("raw-")){const n=e.split("-")[1];if("html"===n){const e=newEl("div",{class:"tf-wrapper raw-html",id:t,"data-box":lastBox.id});lastBox.appendChild(e),fetch(t).then((e=>e.text())).then((e=>$(t).innerHTML=e))}else"css"===n?document.head.appendChild(newEl("link",{rel:"stylesheet",href:t})):"javascript"===n&&document.body.appendChild(newEl("script",{src:t}))}else e.startsWith("img-")||e.startsWith("name-")||(s[e]=t)})),Object.keys(s).length&&addOptionsElement(s)},loadCredentials=async()=>{try{const e=await fetch(`${esp}wifi/credentials?_=${Date.now()}`);if(!e.ok)return;if(wifiCredentials=await e.json(),selectedCredentialIndex=wifiCredentials.length?0:-1,wifiCredentials.length>1)if("undefined"==typeof renderCredentialTabs){const e=document.createElement("script");e.src="creds.js",e.onload=()=>renderCredentialTabs(),document.body.appendChild(e)}else renderCredentialTabs();else $("wifi-cred-tabs")&&($("wifi-cred-tabs").innerHTML=""),["delete-cred","clear-creds","cred-actions-inline"].forEach(hide);selectedCredentialIndex>=0&&window.applyCredential(wifiCredentials[0])}catch(e){console.error(e)}};window.applyCredential=e=>{$("ssid").value=e.ssid||"",$("ssid-name").textContent=e.ssid||"SSID";const t=e.ip&&"0.0.0.0"!==e.ip,n=!t;$("dhcp").checked=n,t?(show("conf-wifi"),$("ip").value=e.ip,$("gateway").value=e.gateway,$("subnet").value=e.subnet):hide("conf-wifi"),$("password").value=""};const hasStoredCredentialFor=e=>wifiCredentials.some((t=>t.ssid===e));function saveParameters(){($("wifi-box").classList.contains("active")||!$("wifi-box").classList.contains("hide"))&&(delete options.dhcp,delete options.ip_address,delete options.gateway,delete options.subnet);const e=new Blob([JSON.stringify(options,null,2)],{type:"application/json"}),t=new FormData;t.append("data",e,"/"+configFile),fetch("/edit",{method:"POST",body:t}).then((()=>openModal("Save",`<br>Saved config to <b>/${configFile}</b>`))).catch((e=>openModal("Error",`Save failed: ${e}`)))}function getWiFiList(){show("loader"),fetch(`${esp}scan`).then((e=>e.json())).then((e=>{e.reload&&setTimeout(getWiFiList,2e3),e.sort(((e,t)=>t.strength-e.strength));const t=$("wifi-list");t.innerHTML="";const n=document.createDocumentFragment();e.forEach(((e,t)=>{const s=newEl("tr",{id:`wifi-${t}`});s.innerHTML=`<td><input type="radio" name="select" id="select-wifi-${t}"></td><td>${e.ssid}</td><td class="hide-tiny">${e.strength} dBm</td><td>${e.security?ICONS.lock:ICONS.unlock}</td>`,s.onclick=()=>{$("ssid").value=e.ssid,$("ssid-name").textContent=e.ssid,$("password").focus();try{$(`select-wifi-${t}`).checked=!0}catch(e){}$("wifi-table").classList.add("hide"),show("show-networks")},n.appendChild(s)})),t.appendChild(n),show("wifi-table"),hide("loader")})).catch((()=>hide("loader")))}function doConnection(e,t){const n=$("ssid").value,s=$("password").value;if(!n||!s&&!hasStoredCredentialFor(n))return openModal("WiFi","Insert SSID & Password");const a=new FormData;a.append("ssid",n),a.append("password",s),a.append("persistent",$("persistent").checked),$("dhcp").checked||(a.append("ip_address",$("ip").value),a.append("gateway",$("gateway").value),a.append("subnet",$("subnet").value)),t&&a.append("newSSID",!0),show("loader"),fetch("/connect",{method:"POST",body:a}).then((t=>t.text().then((n=>{hide("loader"),200!==t.status?openModal("Error",n):n.includes("already")?openModal("WiFi",n,(()=>doConnection(e,!0))):(openModal("WiFi",n,restartESP),loadCredentials())})))).catch((()=>{hide("loader"),openModal("WiFi","Connection failed")}))}function handleUpdate(){const e=$("file-input").files[0];if(!e)return;show("loader"),show("progress-wrap"),$("progress-wrap").classList.add("active"),$("update-log").textContent="Updating...";const t=new FormData;t.append("update",e);const n=new XMLHttpRequest;n.open("POST",`/update?size=${e.size}`),n.onload=()=>{hide("loader"),$("progress-wrap").classList.remove("active"),$("update-log").textContent=200===n.status?n.responseText:"Error";const e=$("file-input"),t=$("fw-label");e&&(e.value=""),t&&(t.textContent=t.dataset.defaultText||"Select firmware binary file",t.removeAttribute("title"),t.style.background=""),$("update-btn")&&$("update-btn").setAttribute("aria-disabled","true"),$("progress-anim")&&($("progress-anim").style.width="0%"),hide("progress-wrap")},n.upload.onprogress=e=>{e.lengthComputable&&($("progress-anim").style.width=`${Math.round(e.loaded/e.total*100)}%`)},n.send(t)}async function uploadFolder(e){const t=Array.from(e.target.files||[]);if(!t.length)return;const n=$("listing"),s=$("pick-label");if(n&&(n.innerHTML=""),s){s.setAttribute("aria-disabled","true"),s.style.background="brown";const e=s.dataset.defaultText||s.textContent;s.textContent=`${e} (${t.length} file${t.length>1?"s":""} selected)`}let a=0,o=0;for(const e of t){const t=e.webkitRelativePath.replace(/^data\//,""),s=newEl("li");s.textContent=t,n&&n.appendChild(s);const i=new FormData;i.append("data",e,"/"+t);try{(await fetch("/edit",{method:"POST",body:i})).ok?a++:(o++,s.style.color="red")}catch(e){o++,s.style.color="red"}}e.target&&(e.target.value=""),s&&(s.textContent=s.dataset.defaultText||"Select the folder containing your files",s.style.background="",s.removeAttribute("aria-disabled"));let i=`<br>Uploaded <b>${a}</b> file${1!==a?"s":""}`;i+=o?`, <b>${o}</b> failed.`:" successfully.",openModal("FS Upload",i)}function switchPage(e){const t=e.target,n=t.getAttribute("data-box");if($("top-nav").classList.remove("responsive"),document.querySelectorAll("a").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.querySelectorAll(".opt-box").forEach((e=>e.classList.add("hide"))),show(n),"set-wifi"!==t.id){const e=$(n);e.appendChild($("btn-hr")),e.appendChild($("btn-box")),document.querySelectorAll(".raw-html").forEach((t=>{t.dataset.box===n&&e.insertBefore(t,$("btn-hr"))})),show("btn-box"),show("btn-hr")}else hide("btn-box"),hide("btn-hr")}window.openModal=(e,t,n)=>{$("message-title").innerHTML=e,$("message-body").innerHTML=t,$("modal-message").open=!0,$("main-box").style.filter="blur(3px)",closeCb=n,(n?show:hide)("ok-modal")},window.closeModal=e=>{$("modal-message").open=!1,$("main-box").style.filter="",e&&closeCb&&closeCb()};const confirmRestart=()=>window.openModal("Restart","Restart now?",restartESP),restartESP=()=>fetch(`${esp}reset`).then((()=>{window.closeModal(),window.openModal("Restarted","ESP Restarted")}));